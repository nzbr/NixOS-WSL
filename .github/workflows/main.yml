name: 'Build NixOS WSL tarball'

on: [push, pull_request, release]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # Nix Flakes doesn't work on shallow clones
          fetch-depth: 0

      - name: Install nix ❄️
        uses: cachix/install-nix-action@v17

      - name: Run checks
        run: |
          nix flake check

      - name: Build tarball
        run: |
          nix build '.#nixosConfigurations.mysystem.config.system.build.tarball'

      - name: Upload tarball
        uses: actions/upload-artifact@v2
        with:
          name: rootfs
          path: result/tarball/nixos-wsl-x86_64-linux.tar.gz

      - name: Build installer
        run: |
          nix build '.#nixosConfigurations.mysystem.config.system.build.installer'

      - name: Upload installer
        uses: actions/upload-artifact@v2
        with:
          name: installer
          path: result/tarball/nixos-wsl-installer.tar.gz

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          name: rootfs

      - name: Install nix ❄️
        uses: cachix/install-nix-action@v17

      - name: Build image 🐳
        run: |
          docker import nixos-wsl-x86_64-linux.tar.gz local:nixos-wsl
          echo $(nix eval .#nixosConfigurations.mysystem.config.users.users.root.shell --raw) > rootshell
          echo -e "FROM local:nixos-wsl\\nENTRYPOINT [\"$(cat rootshell)\"]" > Dockerfile
          docker build -t local:nixos-wsl .

      - name: Start distro
        run: |
          docker run -dt --privileged --name nixos-wsl local:nixos-wsl
          status=1
          sw=/nix/var/nix/profiles/system/sw/bin
          while [[ $status -gt 0 ]]; do
              sleep 1
              docker exec -t --privileged nixos-wsl /bin/sh -c "$sw/nsenter -t \$(</run/systemd.pid) -p -m -- $sw/systemctl is-system-running -q --wait"
              status=$?
          done

      - run: docker exec -t --privileged nixos-wsl $(cat rootshell) true
      - run: docker exec -t --privileged nixos-wsl $(cat rootshell) false


  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: actions/download-artifact@v2
        with:
          name: rootfs

      - uses: actions/download-artifact@v2
        with:
          name: installer

      - name: Generate checksums
        run: |
          for x in *.tar.gz; do
            sha256sum $x > ${x}.sha256
          done

      - name: Attach to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            nixos-wsl-x86_64-linux.tar.gz
            nixos-wsl-x86_64-linux.tar.gz.sha256
            nixos-wsl-installer.tar.gz
            nixos-wsl-installer.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
